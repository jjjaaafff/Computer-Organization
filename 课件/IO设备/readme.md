# IO设备

* 输入输出概念  
输入：数据从IO设备送到CPU内部；输出：从CPU或内存送到IO设备

* 两种评价方式  
每秒传多少个字节；每秒完成多少次传输

* IO性能
  * 衡量指标：吞吐量，反应时间，可靠性，费用
  * 硬件影响：CPU，memory，控制器(并行与串行)，总线(一个协议)
  * 软件影响：操作系统(32bit,64bit)，数据库管理(数据组织方式)，应用(数据操纵)
  * 工作负载：请求的速率和方式(大量一次，小量多次)

* IO处理器  
速度没有CPU处理器快，但管理开支比较大  
如果想要更快需要自己的协处理器  



* 可靠性与可用性
    * 可靠性(Reliability)：实现连续服务的度量，从开始测试到出现故障的时间  
    用平均故障时间MTTF来度量，越大越好
    * 可用性(Availability)：服务实现的度量  
    可用性=MTTF/(MTTF+MTTR)   MTTR为服务发生中断的平均修理时间
    * 提升方式  
    增加MTTF：错误避免，错误容忍，错误预测  
    减小MTTR：降低诊断和修理的时间


* IO的软件管理  
    由操作系统管理，都会被看成资源  
    操作系统提供一个抽象层，与外部IO设备进行交流  
    IO controller：作为中间层连接IO设备，将数据传输并能与操作系统交互。 

* 外部设备被CPU辨认的两种方式
    1. 内存映射(ARM)：把内存范围中的某一段地址定义为IO设备non-cacheable，地址译码器可以进行判断区分。单独划分出来的部分只能被操作系统读写等，用户不能操作(必须经过操作系统的管理)
    2. 特殊的IO指令(x86)：在内存中只用很小一部分。一旦有IN或OUT指令，就会使其对应激活不同的adapter

* Adapter
    * Adapter与CPU的总线有三种，state，command，data 即SCD  
    而Adapter和外部设备之间的连接不一定是这三种线
    * CPU与外界设备交互首先要获取states, 三种方式
        1. Polling查询：周期性的检查IO状态，应用在低成本的嵌入式系统中，可预知时间，硬件成本小。但比较耗时间
        2. Interrupt：一种机制，本身不传输数据。当设备就绪或出错时(event)中断CPU。  
        是通过controller中断，而不是外部设备直接中断。  
        不需要主动check状态。当多中断发生时，中断控制器对其优先级排序。
        3. DMA：以上两种都需要CPU的介入。操作系统开辟内存地址并告知传输字节数，再传输数据。而DMA直接请求接管三总线，CPU先暂时用cache中的数据而不访问存储器。  
    CPU可以拒绝DMA的请求：不传递ack的信号。或当cache中数据用完时，拉高ack，暂停DMA，CPU继续访问存储器。


* DMA存在的问题  
    1. Cache改为dirty但还未写回存储器时，发生DMA取到的是过时数据  

        处理方法
        * 如果cache中的块会被DMA访问，则提前刷新
        * 将内存分为cache与否的两个区域，DMA只访问non-cacheable区域

    2. DMA时IO设备地址连续而物理空间的地址值不连续

        处理方法
       * 将IO设备中的数据按page分割，一个一个page进行传输
       * 在物理空间中强制留一块区域，使其物理与虚拟地址均为连续
       * IO设备地址数据通过虚拟地址逐个转化为物理地址 (比较慢)


* 总线类型
    * Process-memory总线：短，高速
    * IO设备总线：较长，允许多连接  

    过去经常用同步总线，速度快但线比较短  
    现在采用异步，可以从数据信号中恢复出时钟信息，进而实现同步  
    所以这样希望数据的信号跳变越多越好，因为是根据为低时进行恢复


* 磁盘存储器  
有多个盘disk。三个盘从上到下连在一起形成同轴柱体。  
盘上表面的同心圆称为track，同心圆上可以分成小块称为扇区sector  
Sector一般是512字节，是存储的最小单位  
每个盘都有一个头head进行读写。  

  * 两种读取方式
    1. 随机读取：存储位置不连续，耗费时间让磁盘头在不同track间移动
    2. 顺序读取：存储位置连续，只有第一次要找，之后顺着读就行


* 利用RAID提高IO性能  
    * RAID：Redundant Array of Inexpensive (Independent) Disks  
    即用多个小的硬盘并行化操作。Hot swapping  
    同时R提供数据安全性(错误容忍)，如果有硬盘坏了，可以立即在工作时替换。
    * 几种RAID类型
    1. RAID 0：没有冗余(AID)，单纯的并行化处理，提升性能但无法保障数据安全
    2. RAID 1：N+N备份，存多少数据，同等规模对其备份(镜像)
    3. RAID 2：N+E备份，利用error correcting code。对内容每一个bit进行转换保存，一旦出错可以进行纠正。但太复杂了
    4. RAID 5：N+1备份，备份1结合其他硬盘可以恢复任意某个硬盘丢失的数据但坏两个硬盘就没救了
    * RAID效果
        * 可以提高性能和可用性，hot swapping可以提高可用性
        * 数据不容易丢。可以把好几个硬盘同时读和写以提升性能









