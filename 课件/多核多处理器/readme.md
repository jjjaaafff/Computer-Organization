# 多核多处理器

* 多处理器：至少拥有两个处理器的计算机系统。否则称uniprocessor
* 共享主存的多处理器结构SMP

    * 每个处理器通过cache连接到共享的物理地址空间
    * 每个处理器有自己独立的虚拟地址空间
    * 存在着cache不一致的问题，写入同一个地址时会冲突
    * 处理方法
      * 添加监听标记，每个处理器加一个监听标记连接到总线。  
    如果其中一个cache对主存写入，则其他cache都会flush掉该地址的值重新到内存中读取
      * 或者对所有的cache都采用写直达法write through，内存中就会始终有一个最新的备份，但这样速度比较慢。则不用监听标记

* 网络连接的多处理器结构(分布式主存)  
每个处理器有自己私有的物理内存  
对自己的内存访问最快，访问速度不一致，对远的内存访问慢一些

* 多处理器分类
    * 一致性内存访问：内存访问时间相同。共享内存
    * 非一致性内存访问：访问时间取决于地址，距离近的时间短。分布式内存
    * Cache一致的非一致性访问：加上cache一致性确认机制


* 多处理器之间的同步  
    * 问题：一定步骤的程序，在不同处理器运行时，执行先后顺序仍要一致  
    * 在共享内存时，通过共享变量的锁机制处理  
    只有一个对象可以获得使用权，使用时标志置为busy，其他的不能访问。  
    还需要原子交换操作：两个处理器同时发现availible，都将其变busy会出错。  
    即读并写入的操作在一个周期内一气呵成，不可被打断，避免中途修改。  
    这是因为本来读取和修改是两个周期完成的，可能会被中断机制打断
    * 处理方式：两次检查交换值是否为零，先判断再交换再判断，为零则抢到，用完之后再置零，其他处理器可以抢了



* 多核微处理器：单个CPU上，包含多个处理器(核)  
处理单元不共享，可以切开。每个核又可以是多线程的  
高速缓存层次结构：L1区分数据和指令cache与各自核连接，L2是指令和数据cache的统一，不同核的L2cache连接到所有核共享的L3cache，最后L3cache连接主存



* 集群：利用局域网互联一组计算机构成的一个大型多处理器系统。  
对外可看做一台计算机，单个计算机称为节点局域网连接


* 任务与线程的关系  
一个处理器处理很多task或process比如word，PPT  
多处理器就可以把不同task在各个处理器上并行运行  
而每一个task可以分成很多的线程thread  
一个线程是指一段程序在执行过程中不依赖其他线程产生的数据  
任务切换：花时间长，代价大  
而线程切换可以将任务切成很小的单独运行片段  
即使是一个处理器，也可以实现线程切换  


* 多线程技术  
硬件方面：允许多个线程交替执行的方式共享处理器功能  
多线程CPU：多个虚拟的处理器，功能单元是共享使用的
  * 三种线程的切换方式
    1. 细粒度多线程  
    每一条指令完成后都进行线程的切换以允许多线程交叉并行  
    阻塞时间短时还可以，但长了就不如粗粒度  

    2. 粗粒度多线程  
    一直执行同一个线程，当出现阻塞需要较长时间等待(一般是cache Miss)时，切换至另一个线程运行。  
    优点：在没有阻塞的情况下，完成效率非常高
    3. 同时多线程  
    多个线程可以同时并行执行，更加充分利用CPU资源,通过硬件实现





